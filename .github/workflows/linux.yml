name: Linux

on:
  push:
    branches:
      - master
      - 'support/*'
  pull_request: {}

concurrency:
  group: linux-${{ github.event_name == 'push' && github.sha || github.ref }}
  cancel-in-progress: true

jobs:
  linux:
    name: ${{ matrix.distro }}${{ matrix.platform != 'linux/amd64' && format(' ({0})', matrix.platform) || '' }}
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      max-parallel: 2
      matrix:
        distro:
          - amazonlinux:2
          - amazonlinux:2023

          # Raspberry Pi OS is close enough to Debian to test just one of them.
          # Its architecture is different, though, and covered by the Docker job.
          - debian:11
          - debian:12

          - fedora:39
          - fedora:40
          - fedora:41

          - opensuse/leap:15.5
          - opensuse/leap:15.6

          # We don't actually support Rocky Linux as such!
          # We just use that RHEL clone to test the original.
          - rockylinux:8
          - rockylinux:9

          - registry.suse.com/suse/sle15:15.5
          - registry.suse.com/suse/sle15:15.6

          - ubuntu:20.04
          - ubuntu:22.04
          - ubuntu:24.04
          - ubuntu:24.10

        platform:
          - linux/amd64

        include:
          - distro: debian:11
            platform: linux/386
          - distro: debian:12
            platform: linux/386

    steps:
      - name: Checkout HEAD
        uses: actions/checkout@v3

      - name: Restore/backup ccache
        uses: actions/cache@v3
        with:
          path: ccache
          key: ccache/${{ matrix.distro }}

      - name: Build
        run: >-
          docker run --rm -v "$(pwd):/icinga2" -e DISTRO=${{ matrix.distro }}
          --platform ${{ matrix.platform }} ${{ matrix.distro }} /icinga2/.github/workflows/linux.bash
